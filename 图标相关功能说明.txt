# ğŸ“š ä¹¦ç­¾å›¾æ ‡ç®¡ç†åŠŸèƒ½å®ç°æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

åœ¨ä¹¦ç­¾å¯¼å…¥/ç¼–è¾‘é¡µé¢å®ç°äº†å››å¤§å›¾æ ‡åŠŸèƒ½ï¼š
1. **ğŸ“ é€‰æ‹©å›¾æ ‡** - ä»æœ¬åœ°é€‰æ‹©å›¾ç‰‡
2. **â˜ï¸ ä¸Šä¼ å›¾æ ‡** - ä¸Šä¼ å›¾ç‰‡å¹¶è·å–URL
3. **ğŸ² éšæœºå›¾æ ‡** - ä»é¢„è®¾å›¾æ ‡åº“éšæœºè·å–
4. **ğŸ”„ åˆ·æ–°å›¾æ ‡** - æ ¹æ®URLé‡æ–°åŠ è½½/é‡ç½®å›¾æ ‡

---

## ğŸ“± UIç•Œé¢å®ç°

### 1. çŠ¶æ€å˜é‡å®šä¹‰ï¼ˆBookmarkImportSheet.swiftï¼‰

```swift
@State private var isLoadingIcon = false        // å›¾æ ‡åŠ è½½ä¸­
@State private var iconImage: UIImage?          // å½“å‰é€‰æ‹©çš„å›¾ç‰‡
@State private var showImagePicker = false      // æ˜¾ç¤ºå›¾ç‰‡é€‰æ‹©å™¨
@State private var isUploading = false          // ä¸Šä¼ ä¸­çŠ¶æ€
@State private var iconURL: String              // å›¾æ ‡URL
```

### 2. UIå¸ƒå±€

```swift
Section {
    VStack(spacing: 12) {
        // å›¾æ ‡é¢„è§ˆåŒºåŸŸ
        if let image = iconImage {
            Image(uiImage: image)
                .resizable()
                .scaledToFit()
                .frame(maxWidth: 128, maxHeight: 128)
                .cornerRadius(8)
        } else if isLoadingIcon {
            ProgressView()
                .frame(height: 128)
        } else {
            Image(systemName: "photo")
                .font(.system(size: 64))
                .foregroundColor(.secondary)
                .frame(height: 128)
        }
        
        // åŠŸèƒ½æŒ‰é’®
        HStack(spacing: 8) {
            Button("ğŸ“ é€‰æ‹©") {
                showImagePicker = true
            }
            .buttonStyle(.bordered)
            
            Button("â˜ï¸ ä¸Šä¼ ") {
                uploadIcon()
            }
            .buttonStyle(.bordered)
            .disabled(iconImage == nil || isUploading)
            
            Button("ğŸ² éšæœº") {
                generateRandomIcon()
            }
            .buttonStyle(.bordered)
        }
    }
    .frame(maxWidth: .infinity)
} header: {
    Text("å›¾æ ‡")
}

// å›¾æ ‡URLè®¾ç½®åŒº
Section("å›¾æ ‡è®¾ç½®") {
    TextField("å›¾æ ‡URL", text: $iconURL)
        .autocapitalization(.none)
        .keyboardType(.URL)
    
    HStack {
        Button("é‡ç½®") {
            resetIconURL()
        }
        .buttonStyle(.bordered)
        
        Button("åˆ·æ–°") {
            loadIcon()
        }
        .buttonStyle(.bordered)
    }
}
```

---

## ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1ï¸âƒ£ é€‰æ‹©å›¾æ ‡ï¼ˆä»ç›¸å†Œï¼‰

#### ImagePickerï¼ˆUIViewControllerRepresentableï¼‰

```swift
import PhotosUI

struct ImagePicker: UIViewControllerRepresentable {
    @Binding var image: UIImage?
    @Environment(\.dismiss) var dismiss
    
    func makeUIViewController(context: Context) -> PHPickerViewController {
        var config = PHPickerConfiguration()
        config.filter = .images       // åªæ˜¾ç¤ºå›¾ç‰‡
        config.selectionLimit = 1     // åªèƒ½é€‰æ‹©1å¼ 
        
        let picker = PHPickerViewController(configuration: config)
        picker.delegate = context.coordinator
        return picker
    }
    
    func updateUIViewController(_ uiViewController: PHPickerViewController, context: Context) {}
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, PHPickerViewControllerDelegate {
        let parent: ImagePicker
        
        init(_ parent: ImagePicker) {
            self.parent = parent
        }
        
        func picker(_ picker: PHPickerViewController, didFinishPicking results: [PHPickerResult]) {
            parent.dismiss()
            
            guard let provider = results.first?.itemProvider else { return }
            
            if provider.canLoadObject(ofClass: UIImage.self) {
                provider.loadObject(ofClass: UIImage.self) { image, error in
                    DispatchQueue.main.async {
                        self.parent.image = image as? UIImage
                    }
                }
            }
        }
    }
}
```

#### ä½¿ç”¨æ–¹å¼

```swift
.sheet(isPresented: $showImagePicker) {
    ImagePicker(image: $iconImage)
}
```

---

### 2ï¸âƒ£ ä¸Šä¼ å›¾æ ‡

#### ä¸Šä¼ æ–¹æ³•ï¼ˆBookmarkImportSheet.swiftï¼‰

```swift
private func uploadIcon() {
    guard let image = iconImage,
          let imageData = image.pngData() else {
        return
    }
    
    isUploading = true
    
    Task {
        do {
            // è°ƒç”¨ç½‘ç»œæœåŠ¡ä¸Šä¼ 
            let uploadedURL = try await NetworkService.shared.uploadIcon(imageData: imageData)
            await MainActor.run {
                self.iconURL = uploadedURL
                self.isUploading = false
            }
        } catch {
            await MainActor.run {
                self.isUploading = false
                self.errorMessage = "ä¸Šä¼ å¤±è´¥: \(error.localizedDescription)"
                self.showError = true
            }
        }
    }
}
```

#### ç½‘ç»œæœåŠ¡å®ç°ï¼ˆNetworkService.swiftï¼‰

```swift
func uploadIcon(imageData: Data) async throws -> String {
    let urlString = "http://www.hd-r.cn/api/upload"  // ä¸Šä¼ APIåœ°å€
    guard let url = URL(string: urlString) else {
        throw NetworkError.invalidURL
    }
    
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    
    // ä½¿ç”¨multipart/form-dataæ ¼å¼
    let boundary = UUID().uuidString
    request.setValue("multipart/form-data; boundary=\(boundary)", forHTTPHeaderField: "Content-Type")
    
    var body = Data()
    
    // æ„å»ºmultipart body
    body.append("--\(boundary)\r\n".data(using: .utf8)!)
    body.append("Content-Disposition: form-data; name=\"file\"; filename=\"icon.png\"\r\n".data(using: .utf8)!)
    body.append("Content-Type: image/png\r\n\r\n".data(using: .utf8)!)
    body.append(imageData)
    body.append("\r\n".data(using: .utf8)!)
    body.append("--\(boundary)--\r\n".data(using: .utf8)!)
    
    request.httpBody = body
    
    let (data, response) = try await URLSession.shared.data(for: request)
    
    guard let httpResponse = response as? HTTPURLResponse else {
        throw NetworkError.invalidResponse
    }
    
    guard httpResponse.statusCode == 200 else {
        let message = String(data: data, encoding: .utf8) ?? ""
        throw NetworkError.httpError(httpResponse.statusCode, message)
    }
    
    // è§£æè¿”å›çš„URL
    struct UploadResponse: Codable {
        let link: String
    }
    
    guard let uploadResponse = try? JSONDecoder().decode(UploadResponse.self, from: data) else {
        throw NetworkError.decodingError
    }
    
    return uploadResponse.link
}
```

---

### 3ï¸âƒ£ éšæœºå›¾æ ‡

#### RandomIconProviderå·¥å…·ç±»ï¼ˆRandomIconProvider.swiftï¼‰

```swift
import Foundation

struct RandomIconProvider {
    static let shared = RandomIconProvider()
    
    private init() {}
    
    // å›¾æ ‡é›†åˆï¼šåç§° -> (èµ·å§‹ç¼–å·, ç»“æŸç¼–å·, æ–‡ä»¶æ‰©å±•å)
    private let iconCollections: [String: (start: Int, end: Int, ext: String)] = [
        "AttackOnTitan": (1001, 1084, "png"),
        "Digimon": (1001, 1056, "png"),
        "Doraemon": (1001, 1100, "png"),
        "Genshin": (1001, 1160, "png"),
        "Maruko-chan": (1001, 1100, "png"),
        "Naruto": (1001, 1284, "png"),
        "OnePiece": (1001, 1100, "png"),
        "Pokemon": (1001, 1112, "png"),
        "PokemonGif": (1001, 1056, "gif"),
        "Shin-Miya": (1001, 1100, "png"),
        "Shin-chan": (1001, 1100, "png"),
        "Stitch": (1001, 1100, "png"),
        "Tom-Jerry": (1001, 1100, "png"),
        "Transformers": (1001, 1048, "png"),
        "Weslie-Wolffy": (1001, 1100, "png")
    ]
    
    func getRandomIconURL() -> String {
        let keys = Array(iconCollections.keys)
        guard let randomKey = keys.randomElement(),
              let collection = iconCollections[randomKey] else {
            return ""
        }
        
        // åœ¨èŒƒå›´å†…éšæœºé€‰æ‹©ç¼–å·
        let randomNumber = Int.random(in: collection.start...collection.end)
        let baseURL = "https://raw.githubusercontent.com/DeerFishSheep/Quantumult/refs/heads/main/icon/"
        
        return "\(baseURL)\(randomKey)/\(randomKey)-\(randomNumber).\(collection.ext)"
    }
}
```

#### è°ƒç”¨æ–¹å¼

```swift
private func generateRandomIcon() {
    iconURL = RandomIconProvider.shared.getRandomIconURL()
    loadIcon()  // è‡ªåŠ¨åŠ è½½æ–°å›¾æ ‡
}
```

---

### 4ï¸âƒ£ åˆ·æ–°/é‡ç½®å›¾æ ‡

#### URLå›¾æ ‡ç”Ÿæˆå·¥å…·ï¼ˆURLExtractor.swiftï¼‰

```swift
import Foundation

struct URLExtractor {
    // æå–åŸŸå
    static func extractDomain(from urlString: String) -> String {
        var processedURL = urlString
        if !urlString.hasPrefix("http://") && !urlString.hasPrefix("https://") {
            processedURL = "https://" + urlString
        }
        
        guard let url = URL(string: processedURL),
              let host = url.host else {
            return urlString
        }
        
        return "\(url.scheme ?? "https")://\(host)"
    }
    
    // ç”Ÿæˆå›¾æ ‡URLï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹APIï¼‰
    static func generateIconURL(from urlString: String) -> String {
        let domain = extractDomain(from: urlString)
        return "https://api.afmax.cn/so/ico/index.php?r=\(domain)"
    }
}
```

#### é‡ç½®å’Œåˆ·æ–°æ–¹æ³•

```swift
// é‡ç½®ï¼šæ ¹æ®ç½‘ç«™URLé‡æ–°ç”Ÿæˆå›¾æ ‡URL
private func resetIconURL() {
    if !url.isEmpty {
        iconURL = URLExtractor.generateIconURL(from: url)
        loadIcon()
    }
}

// åˆ·æ–°ï¼šé‡æ–°åŠ è½½å½“å‰å›¾æ ‡URL
private func loadIcon() {
    guard !iconURL.isEmpty else { return }
    
    isLoadingIcon = true
    
    Task {
        do {
            let (data, _) = try await URLSession.shared.data(from: URL(string: iconURL)!)
            if let image = UIImage(data: data) {
                await MainActor.run {
                    self.iconImage = image
                    self.isLoadingIcon = false
                }
            }
        } catch {
            await MainActor.run {
                self.isLoadingIcon = false
            }
        }
    }
}
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### åˆå§‹åŒ–æµç¨‹

```swift
init(...) {
    // ...å…¶ä»–åˆå§‹åŒ–...
    
    // å›¾æ ‡URLå¤„ç†
    if !initialLogo.isEmpty {
        // 1. å·²æœ‰å›¾æ ‡URLç›´æ¥ä½¿ç”¨
        _iconURL = State(initialValue: initialLogo)
    } else if mode != .manual && !initialURL.isEmpty {
        // 2. éæ‰‹åŠ¨æ¨¡å¼ä¸”æœ‰URLæ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå›¾æ ‡URL
        let generatedURL = URLExtractor.generateIconURL(from: initialURL)
        _iconURL = State(initialValue: generatedURL)
    } else {
        // 3. æ‰‹åŠ¨æ¨¡å¼æˆ–æ— URLæ—¶ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
        _iconURL = State(initialValue: "")
    }
}

// é¡µé¢å‡ºç°æ—¶è‡ªåŠ¨åŠ è½½å›¾æ ‡
.onAppear {
    if mode != .manual {
        loadIcon()
    }
}
```

### ç”¨æˆ·æ“ä½œæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"ğŸ“ é€‰æ‹©"
   â†“
   æ‰“å¼€ç³»ç»Ÿç›¸å†Œ (PHPickerViewController)
   â†“
   é€‰æ‹©å›¾ç‰‡åæ›´æ–° iconImage
   
2. ç”¨æˆ·ç‚¹å‡»"â˜ï¸ ä¸Šä¼ "
   â†“
   å°† iconImage è½¬ä¸º PNG Data
   â†“
   é€šè¿‡ multipart/form-data ä¸Šä¼ 
   â†“
   è·å–æœåŠ¡å™¨è¿”å›çš„å›¾æ ‡URL
   â†“
   æ›´æ–° iconURL

3. ç”¨æˆ·ç‚¹å‡»"ğŸ² éšæœº"
   â†“
   ä»15ä¸ªå›¾æ ‡é›†åˆä¸­éšæœºé€‰æ‹©
   â†“
   ç”ŸæˆGitHubå›¾æ ‡URL
   â†“
   è‡ªåŠ¨åŠ è½½æ–°å›¾æ ‡

4. ç”¨æˆ·ç‚¹å‡»"é‡ç½®"
   â†“
   æ ¹æ®ç½‘ç«™URLé‡æ–°ç”Ÿæˆå›¾æ ‡URL
   â†“
   è‡ªåŠ¨åŠ è½½æ–°å›¾æ ‡

5. ç”¨æˆ·ç‚¹å‡»"åˆ·æ–°"
   â†“
   ä½¿ç”¨å½“å‰iconURLé‡æ–°ä¸‹è½½å›¾ç‰‡
```

---

## ğŸ“¦ å¯å¤ç”¨ç»„ä»¶æ¸…å•

### å¤åˆ¶åˆ°å…¶ä»–é¡¹ç›®éœ€è¦çš„æ–‡ä»¶ï¼š

1. **RandomIconProvider.swift** - éšæœºå›¾æ ‡å·¥å…·ç±»ï¼ˆå¯è‡ªå®šä¹‰å›¾æ ‡æºï¼‰
2. **URLExtractor.swift** - URLåŸŸåæå–å’Œå›¾æ ‡ç”Ÿæˆ
3. **ImagePicker** - ç³»ç»Ÿç›¸å†Œé€‰æ‹©å™¨å°è£…
4. **NetworkService.uploadIcon** - å›¾ç‰‡ä¸Šä¼ æ–¹æ³•

### ä¾èµ–é¡¹ï¼š

```swift
import SwiftUI
import PhotosUI  // ç›¸å†Œé€‰æ‹©å™¨éœ€è¦
```

### ä¿®æ”¹å»ºè®®ï¼š

1. **ä¸Šä¼ åœ°å€**ï¼šä¿®æ”¹ `NetworkService.uploadIcon` ä¸­çš„ä¸Šä¼ APIåœ°å€
2. **å›¾æ ‡æº**ï¼šä¿®æ”¹ `RandomIconProvider` ä¸­çš„å›¾æ ‡é›†åˆæ•°æ®
3. **å›¾æ ‡API**ï¼šä¿®æ”¹ `URLExtractor.generateIconURL` ä¸­çš„ç¬¬ä¸‰æ–¹å›¾æ ‡API

---

## âœ¨ ç‰¹è‰²åŠŸèƒ½

1. **è‡ªåŠ¨ç”Ÿæˆ**ï¼šæ ¹æ®ç½‘ç«™URLè‡ªåŠ¨è·å–favicon
2. **å¤šç§æ¥æº**ï¼šæ”¯æŒç›¸å†Œã€ä¸Šä¼ ã€éšæœºã€URLå››ç§æ–¹å¼
3. **é¢„è§ˆåŠ è½½**ï¼šå®æ—¶é¢„è§ˆå›¾æ ‡ï¼Œæ”¯æŒåŠ è½½çŠ¶æ€æ˜¾ç¤º
4. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯æç¤ºå’Œå¼‚å¸¸å¤„ç†
5. **å¼‚æ­¥åŠ è½½**ï¼šä½¿ç”¨ Swift Concurrency å®ç°æµç•…çš„å¼‚æ­¥æ“ä½œ

---

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ åœ¨å…¶ä»–é¡¹ç›®ä¸­å¿«é€Ÿå®ç°ç›¸åŒçš„åŠŸèƒ½ï¼å¦‚éœ€è¦æˆ‘å¸®ä½ è°ƒæ•´ä»»ä½•éƒ¨åˆ†ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚